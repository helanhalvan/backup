import Ped_util.Agent_passive
import Ped_util.Global_funs
class Main {
   def main(args: [String]) : void {
       var agents=parse_file("slow_down.xml");
       var ui =false;
        this!baseline(agents,ui);
   }
def baseline(agents: [Agent], ui:bool) : void {
        var i = 0;
        var drivers= new [Agent_driver]( |agents| );
        var futures= new [Fut void](|agents|);
        var j = 0;
         for a in agents {
             drivers[i]=new Agent_driver(a,|agents|);
             i=i+1;
         };
         i=0;
         for a in drivers{
             for b in drivers {
                 unless (a==b) then {
                 a!link(b);
                 }
             }
         };
         this!baseline_loop(4000,drivers,futures,ui,0);
 }
def baseline_loop(i:int,drivers:[Agent_driver],futures:[Fut void],ui:bool,times:int) : void {
             var j = 0;
             var last_time=clock();
             var t = times;
             for a in drivers {
                 futures[j]=a.move();
                 j=j+1;
             };
             for a in futures {
                 get(a);
             };
             if(i % 100==0) then {
                 print("{} {}\n",i, t);
                t=0;
             } else {
                t=t+clock()-last_time;
            };
         if i>0 then this!baseline_loop(i-1, drivers,futures,ui,t);
 }
}
class Agent_driver {
    agent : Agent
    links : [Agent_driver]
    index : int
    def get_pos() : (int,int) {
        this.agent.pos();
    }
    def init(a:Agent,size:int) : void {
        this.agent=a;
        this.links=new [Agent_driver](size-1);
        this.index=0;
    }
    def link(a:Agent_driver) : void {
        this.links[this.index]=a;
        this.index=this.index+1;
    }
    def move() : void {
        for desired in this.agent.next() {
            var futures = new [Fut bool](|this.links|);
            var i = 0;
            var full = false;
            {
            for a in this.links {
                --print("{},{},{}\n",i,futures[i],a);
                futures[i]=a.there(desired);
                i=i+1;
            };
            i=0;
            while (i < |futures| ) {
                await(futures[i]);
                full = full or get(futures[i]);
                i=i+1;
            };
            if full==false then {
                this.agent.move(desired);
                embed void { break; } end;
            }
        }};
        ()
    }
    def there(pos:(int,int)) : bool {
        if (equal(this.agent.pos(),pos)) then true
        else false
    }
}
