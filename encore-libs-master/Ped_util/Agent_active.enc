module Agent_active
import Agent_passive
import Global_funs
class Agent_driver {
    agent : Agent
    links : [Agent_driver]
    index : int
    def get_pos() : (int,int) {
        this.agent.pos;
    }
    def init(a:Agent,size:int) : void {
        this.agent=a;
        this.links=new [Agent_driver](size-1);
        this.index=0;
    }
    def link(a:Agent_driver) : void {
        this.links[this.index]=a;
        this.index=this.index+1;
    }
    def move() : void {
        for desired in this.agent.next() {
            let
                futures = new [Fut bool](|this.links|)
                i = 0
                full = false
            in {
            for a in this.links {
                --print("{},{},{}\n",i,futures[i],a);
                futures[i]=a.there(desired);
                i=i+1;
            };
            i=0;
            for f in futures {
                await(f);
                full = full or get(f);
            };
            if full==false then {
                this.agent.move(desired);
                embed void { break; } end;
            }
        }};
        ()
    }
    def there(pos:(int,int)) : bool {
        if (equal(this.agent.pos(),pos)) then true
        else false
    }
}
--}
